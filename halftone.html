<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Halftone Config Generator (White Paper Mode)</title>
    <style>
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f0f0; /* Light body background */
            color: #333; 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Layout --- */
        .header { text-align: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        /* --- Preview Area --- */
        .preview-section { 
            flex: 2; 
            min-width: 600px; 
            display: flex; 
            gap: 10px; 
            justify-content: center;
        }
        .view-pane { 
            flex: 1; 
            background: #fff; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .view-pane h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        /* UPDATED: White Background for the "Paper" */
        .img-wrapper {
            position: relative;
            width: 100%;
            height: 500px; 
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff; 
            overflow: hidden;
            border: 1px solid #eee;
        }
        img { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
        }
        
        .halftone-effect { filter: url(#master-filter); }

        /* --- Controls Area --- */
        .controls-section { 
            flex: 1; 
            min-width: 320px; 
            max-width: 400px; 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #ccc;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .control-group:last-child { border-bottom: none; }
        .control-group h4 { margin: 0 0 10px 0; color: #2196F3; font-size: 0.9rem; text-transform: uppercase; }

        label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #666; }
        .val-display { color: #2196F3; font-family: monospace; font-weight: bold; }
        
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #2196F3; margin-bottom: 10px; }
        input[type="color"] { width: 100%; height: 35px; border: 1px solid #ddd; cursor: pointer; background: none; }
        
        button { width: 100%; padding: 10px; margin-top: 5px; background: #eee; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #ddd; }
        button.active { background: #2196F3; color: #fff; border-color: #2196F3; }

        textarea { width: 100%; height: 220px; background: #f9f9f9; color: #333; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 0.85rem; resize: vertical; margin-top: 10px; white-space: pre; }

        .svg-engine { position: absolute; width: 0; height: 0; overflow: hidden; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Halftone Config Generator (White Paper)</h2>
    </div>

    <div class="main-container">
        
        <div class="preview-section">
            <div class="view-pane">
                <h3>Original Source</h3>
                <div class="img-wrapper">
                    <img id="img-source" src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600" crossorigin="anonymous">
                </div>
            </div>
            <div class="view-pane">
                <h3>Halftone Result</h3>
                <div class="img-wrapper">
                    <img id="img-result" class="halftone-effect" src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600" crossorigin="anonymous">
                </div>
            </div>
        </div>

        <div class="controls-section">
            
            <div class="control-group">
                <h4>1. Image & Mode</h4>
                <input type="file" id="file-upload" accept="image/*">
                <button id="btn-grayscale" class="active" onclick="toggleGrayscale()">Mode: Ink (Inverted)</button>
            </div>

            <div class="control-group">
                <h4>2. Grid Geometry</h4>
                <label>Dot Size <span class="val-display" id="val-size">8</span></label>
                <input type="range" id="inp-size" min="2" max="60" value="8" oninput="updateFilter()">
                
                <label>Angle <span class="val-display" id="val-angle">19</span>Â°</label>
                <input type="range" id="inp-angle" min="0" max="90" value="19" oninput="updateFilter()">
            </div>

            <div class="control-group">
                <h4>3. Organic Noise</h4>
                <label>Distortion (Warp) <span class="val-display" id="val-warp">2</span></label>
                <input type="range" id="inp-warp" min="0" max="50" value="2" oninput="updateFilter()">
                
                <label>Roughness (Freq) <span class="val-display" id="val-freq">0.17</span></label>
                <input type="range" id="inp-freq" min="0.01" max="0.5" step="0.01" value="0.17" oninput="updateFilter()">
            </div>

            <div class="control-group">
                <h4>4. Ink Dynamics</h4>
                <label>Ink Bleed (Blur) <span class="val-display" id="val-blur">1.8</span></label>
                <input type="range" id="inp-blur" min="0" max="5" step="0.1" value="1.8" oninput="updateFilter()">
                
                <label>Contrast (Slope) <span class="val-display" id="val-slope">2.0</span></label>
                <input type="range" id="inp-slope" min="1" max="20" step="0.5" value="2.0" oninput="updateFilter()">
                
                <label>Density (Intercept) <span class="val-display" id="val-intercept">0.1</span></label>
                <input type="range" id="inp-intercept" min="-2" max="2" step="0.1" value="0.1" oninput="updateFilter()">
                
                <label>Ink Color</label>
                <input type="color" id="inp-color" value="#222222" oninput="updateFilter()">
            </div>

            <div class="control-group">
                <h4>5. Component Config</h4>
                <button onclick="copyCode()">Copy Config Object</button>
                <textarea id="code-output" readonly></textarea>
            </div>
        </div>
    </div>

    <svg class="svg-engine">
        <defs>
            <filter id="master-filter" x="-20%" y="-20%" width="140%" height="140%" color-interpolation-filters="sRGB">
                
                <feColorMatrix id="f-grayscale" in="SourceGraphic" type="matrix" 
                    values="-0.21 -0.72 -0.07 0 1 
                            -0.21 -0.72 -0.07 0 1 
                            -0.21 -0.72 -0.07 0 1 
                             0     0     0    1 0" 
                    result="gray-layer"/>

                <feImage id="f-pattern" x="0" y="0" width="3000" height="3000" result="dot-layer" href=""/>
                
                <feTurbulence id="f-noise" type="fractalNoise" baseFrequency="0.17" numOctaves="2" result="noise-map"/>
                <feDisplacementMap id="f-disp" in="dot-layer" in2="noise-map" scale="2" xChannelSelector="R" yChannelSelector="G" result="distorted-dots"/>

                <feGaussianBlur id="f-blur" in="distorted-dots" stdDeviation="1.8" result="soft-dots"/>

                <feComposite in="gray-layer" in2="soft-dots" operator="arithmetic" k1="1" k2="0" k3="0" k4="0" result="masked-layer"/>

                <feComponentTransfer in="masked-layer" result="threshold-layer">
                    <feFuncR id="f-func-r" type="linear" slope="2" intercept="0.1"/>
                    <feFuncG id="f-func-g" type="linear" slope="2" intercept="0.1"/>
                    <feFuncB id="f-func-b" type="linear" slope="2" intercept="0.1"/>
                </feComponentTransfer>

                <feColorMatrix id="f-colorize" in="threshold-layer" type="matrix"
                    values="0 0 0 0 0.13 
                            0 0 0 0 0.13 
                            0 0 0 0 0.13 
                            1 0 0 0 0" />
            </filter>
        </defs>
    </svg>

    <script>
        let isGrayscale = true; 

        const ui = {
            size: document.getElementById('inp-size'),
            angle: document.getElementById('inp-angle'),
            warp: document.getElementById('inp-warp'),
            freq: document.getElementById('inp-freq'),
            blur: document.getElementById('inp-blur'),
            slope: document.getElementById('inp-slope'),
            intercept: document.getElementById('inp-intercept'),
            color: document.getElementById('inp-color'),
            file: document.getElementById('file-upload'),
            imgSrc: document.getElementById('img-source'),
            imgRes: document.getElementById('img-result'),
            code: document.getElementById('code-output')
        };

        const filter = {
            pattern: document.getElementById('f-pattern'),
            noise: document.getElementById('f-noise'),
            disp: document.getElementById('f-disp'),
            blur: document.getElementById('f-blur'),
            funcR: document.getElementById('f-func-r'),
            funcG: document.getElementById('f-func-g'),
            funcB: document.getElementById('f-func-b'),
            grayscale: document.getElementById('f-grayscale'),
            colorize: document.getElementById('f-colorize')
        };

        function updateFilter() {
            // UI Labels
            document.getElementById('val-size').textContent = ui.size.value;
            document.getElementById('val-angle').textContent = ui.angle.value;
            document.getElementById('val-warp').textContent = ui.warp.value;
            document.getElementById('val-freq').textContent = ui.freq.value;
            document.getElementById('val-blur').textContent = ui.blur.value;
            document.getElementById('val-slope').textContent = ui.slope.value;
            document.getElementById('val-intercept').textContent = ui.intercept.value;

            // 1. Rotation Logic
            const s = parseInt(ui.size.value);
            const a = ui.angle.value;
            const r = s * 0.45;
            
            const svgString = `
                <svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%'>
                    <defs>
                        <pattern id='p' width='${s}' height='${s}' patternUnits='userSpaceOnUse' patternTransform='rotate(${a})'>
                            <rect width='100%' height='100%' fill='black'/>
                            <circle cx='${s/2}' cy='${s/2}' r='${r}' fill='white'/>
                        </pattern>
                    </defs>
                    <rect width='100%' height='100%' fill='url(#p)'/>
                </svg>`;
            
            const base64Pattern = 'data:image/svg+xml;base64,' + btoa(svgString);
            filter.pattern.setAttribute('width', '3000'); 
            filter.pattern.setAttribute('height', '3000');
            filter.pattern.setAttribute('href', base64Pattern); 

            // 2. Params
            filter.noise.setAttribute('baseFrequency', ui.freq.value);
            filter.disp.setAttribute('scale', ui.warp.value);
            filter.blur.setAttribute('stdDeviation', ui.blur.value);

            [filter.funcR, filter.funcG, filter.funcB].forEach(el => {
                el.setAttribute('slope', ui.slope.value);
                el.setAttribute('intercept', ui.intercept.value);
            });

            // 3. Color Logic
            if(isGrayscale) {
                const hex = ui.color.value;
                const r = parseInt(hex.slice(1,3), 16) / 255;
                const g = parseInt(hex.slice(3,5), 16) / 255;
                const b = parseInt(hex.slice(5,7), 16) / 255;
                // Map alpha to Ink Color
                filter.colorize.setAttribute('values', `0 0 0 0 ${r}  0 0 0 0 ${g}  0 0 0 0 ${b}  1 0 0 0 0`);
            } else {
                // Identity for color mode
                filter.colorize.setAttribute('values', `1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1 0`);
            }

            // Repaint
            ui.imgRes.style.display = 'none';
            ui.imgRes.offsetHeight; 
            ui.imgRes.style.display = 'block';

            // 4. Generate Config
            const configObj = {
                size: parseInt(ui.size.value),
                angle: parseInt(ui.angle.value),
                warp: parseFloat(ui.warp.value),
                freq: parseFloat(ui.freq.value),
                octaves: 2,
                blur: parseFloat(ui.blur.value),
                slope: parseFloat(ui.slope.value),
                intercept: parseFloat(ui.intercept.value),
                // IMPORTANT: We tell the component to use the inverted logic
                invert: isGrayscale, 
                inkColor: ui.color.value
            };
            
            ui.code.value = JSON.stringify(configObj, null, 2);
        }

        window.toggleGrayscale = function() {
            isGrayscale = !isGrayscale;
            const btn = document.getElementById('btn-grayscale');
            
            if(isGrayscale) {
                btn.classList.add('active');
                btn.textContent = "Mode: Ink (Inverted)";
                // Inverted Grayscale Matrix: Dark = High Value
                filter.grayscale.setAttribute('values', 
                    "-0.21 -0.72 -0.07 0 1 " +
                    "-0.21 -0.72 -0.07 0 1 " +
                    "-0.21 -0.72 -0.07 0 1 " +
                    " 0     0     0    1 0"
                );
            } else {
                btn.classList.remove('active');
                btn.textContent = "Mode: Original Color";
                // Standard Identity
                filter.grayscale.setAttribute('values', "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1 0");
            }
            updateFilter(); 
        };

        window.copyCode = function() {
            ui.code.select();
            document.execCommand("copy");
            alert("Configuration copied to clipboard!");
        };

        ui.file.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                ui.imgSrc.src = event.target.result;
                ui.imgRes.src = event.target.result;
                setTimeout(updateFilter, 100);
            };
            reader.readAsDataURL(file);
        });

        window.onload = updateFilter;

    </script>
</body>
</html>
